package incrementor

import (
	"math"
	"sync"
)

type (
	// Incrementor —è–≤–ª—è–µ—Ç—Å—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–º —á–∏—Å–ª–æ–º —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è, –≤—Ä–æ–¥–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.
	Incrementor struct {
		// NOTE(toby3d): –∑–∞—â–∏—Ç–∞ —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ —á–∏—Å–ª–∞ –≤ –≥–æ—Ä—É—Ç–∏–Ω–∞—Ö
		mutex *sync.RWMutex

		// NOTE(toby3d): –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ —Å–∞–º–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω–æ–µ —á–∏—Å–ª–æ
		number int64

		// NOTE(toby3d): –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω–æ–≥–æ —á–∏—Å–ª–∞, –ø–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–Ω–æ –±—É–¥–µ—Ç
		// —Å–±—Ä–æ—à–µ–Ω–æ –≤ 0
		maxValue int64
	}

	// Reader –æ–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è —á–∏—Å–ª–∞.
	Reader interface {
		GetNumber() int64
	}

	// Writer –æ–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è —á–∏—Å–ª–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –µ–≥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º.
	Writer interface {
		IncrementNumber()
		SetMaximumValue(maximumValue int)
	}

	// Incrementer –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω–æ–≥–æ —á–∏—Å–ª–∞.
	Incrementer interface {
		Reader
		Writer
	}
)

// DefaultMaximumValue —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —á–∏—Å–ª–∞ –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é –≤ –±–∏—Ç–∞—Ö.
const DefaultMaximumValue = math.MaxInt64

// New —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–º —á–∏—Å–ª–æ–º.
//
// NOTE(toby3d): –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –∑–∞–¥–∞–Ω–∏–∏ –Ω–µ—Ç —Å–≤–µ–¥–µ–Ω–∏–π –ø–æ —Ç–æ–º—É –≤–æ–∑–º–æ–∂–Ω–æ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–∞ —ç—Ç–∞–ø–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –∫–∞–∫
// –Ω–∞–ø—Ä–∏–º–µ—Ä –æ—Ç—Å—á—ë—Ç –Ω–µ —Å 0 –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞ –±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ SetMaximumValue. ü§∑‚Äç‚ôÇ
func New() *Incrementor {
	i := new(Incrementor)
	i.number = 0
	i.mutex = new(sync.RWMutex)
	i.maxValue = DefaultMaximumValue

	return i
}

// GetNumber –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —á–∏—Å–ª–æ.
func (i *Incrementor) GetNumber() int64 {
	i.mutex.RLock()
	defer i.mutex.RUnlock()

	return i.number
}

// IncrementNumber —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —á–∏—Å–ª–æ –Ω–∞ 1.
//
// –ï—Å–ª–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–µ—Ç–æ–¥–∞ —á–∏—Å–ª–æ –±—É–¥–µ—Ç >= –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –ø–æ—Ä–æ–≥–∞, —Ç–æ –æ–Ω–æ –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω–æ –≤ 0.
func (i *Incrementor) IncrementNumber() {
	i.mutex.Lock()

	i.number++

	if i.number >= i.maxValue {
		i.number = 0
	}

	i.mutex.Unlock()
}

// SetMaximumValue —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —á–∏—Å–ª–∞. –ü–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ
// –ø–æ—Ä–æ–≥–∞ —á–∏—Å–ª–æ –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω–æ –≤ 0.
//
// –í–≤–æ–¥–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0 –∏ –±–æ–ª—å—à–µ DefaultMaximumValue.
func (i *Incrementor) SetMaximumValue(maximumValue int64) {
	// NOTE(toby3d): –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–≤–æ–¥, –∫–æ—Å—è—á–Ω—ã–π —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é.
	if maximumValue <= 0 || maximumValue > DefaultMaximumValue {
		maximumValue = DefaultMaximumValue
	}

	i.mutex.Lock()

	i.maxValue = maximumValue

	// NOTE(toby3d): –µ—Å–ª–∏ –º–∞–∫—Å–∏–º—É–º –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è, —Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —á–∏—Å–ª–æ –≤ 0.
	if i.number >= i.maxValue {
		i.number = 0
	}

	i.mutex.Unlock()
}
